#pragma region Apache License 2.0
/*
Nuclex Native Framework
Copyright (C) 2002-2024 Markus Ewald / Nuclex Development Labs

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
#pragma endregion // Apache License 2.0

// If the library is compiled as a DLL, this ensures symbols are exported
#define NUCLEX_SUPPORT_SOURCE 1

#include "Nuclex/Support/Text/StringConverter.h"

#include <gtest/gtest.h>

namespace Nuclex { namespace Support { namespace Text {

  // ------------------------------------------------------------------------------------------- //

  TEST(StringConverterTest, CanConvertUtf8ToWide) {
    std::u8string text = u8"ÄƒÑ£ğ” Õ®á»Å¿Ä£ÈŸá¥ğ’‹Ç©Ä¾á¸¿ê‘È¯ğ˜±ğ‘ğ—‹ğ˜´È¶ğ„ğœˆÏˆğ’™ğ˜†ğš£";
    EXPECT_EQ(
      StringConverter::WideFromUtf8(text),
      std::wstring(L"ÄƒÑ£ğ” Õ®á»Å¿Ä£ÈŸá¥ğ’‹Ç©Ä¾á¸¿ê‘È¯ğ˜±ğ‘ğ—‹ğ˜´È¶ğ„ğœˆÏˆğ’™ğ˜†ğš£")
    );

    text = u8"ğ˜ˆá¸†ğ–¢ğ•¯Ù¤á¸ÔĞÇğ™…Æ˜Ô¸â²˜ğ™‰à§¦Î¡ğ—¤ÉŒğ“¢ÈšĞ¦ğ’±Ñ ğ“§Æ³È¤Ñ§á–¯Ä‡ğ—±á»…ğ‘“ğ™œá‚¹ğ²ğ‘—ğ’ŒÄ¼á¹ƒÅ‰Ğ¾ğğ’’áµ²êœ±ğ™©á»«ğ—Åµğ’™ğ’šÅº";
    EXPECT_EQ(
      StringConverter::WideFromUtf8(text),
      std::wstring(L"ğ˜ˆá¸†ğ–¢ğ•¯Ù¤á¸ÔĞÇğ™…Æ˜Ô¸â²˜ğ™‰à§¦Î¡ğ—¤ÉŒğ“¢ÈšĞ¦ğ’±Ñ ğ“§Æ³È¤Ñ§á–¯Ä‡ğ—±á»…ğ‘“ğ™œá‚¹ğ²ğ‘—ğ’ŒÄ¼á¹ƒÅ‰Ğ¾ğğ’’áµ²êœ±ğ™©á»«ğ—Åµğ’™ğ’šÅº")
    );

    text = u8"Ğá¸‚â²¤ğ——ğ–¤ğ—™ê ê“§ÈŠğ‰ğœ¥ê“¡ğ‘€ğ‘µÇ¬ğ™¿ğ‘„Å–ğ‘†ğ’¯ğ–´ğ˜ğ˜ê“«Å¸ğœ¡áº£ğ˜¢Æ€ğ–¼á¸‹áº¿áµ®â„Šğ™á¥ğ•›ĞºÎ¹á¹ƒÕ¤â±ºğ“…ğ˜²ğ•£ğ–˜Å§ğ‘¢á¹½áº‰ğ˜…áƒ§Å¾";
    EXPECT_EQ(
      StringConverter::WideFromUtf8(text),
      std::wstring(L"Ğá¸‚â²¤ğ——ğ–¤ğ—™ê ê“§ÈŠğ‰ğœ¥ê“¡ğ‘€ğ‘µÇ¬ğ™¿ğ‘„Å–ğ‘†ğ’¯ğ–´ğ˜ğ˜ê“«Å¸ğœ¡áº£ğ˜¢Æ€ğ–¼á¸‹áº¿áµ®â„Šğ™á¥ğ•›ĞºÎ¹á¹ƒÕ¤â±ºğ“…ğ˜²ğ•£ğ–˜Å§ğ‘¢á¹½áº‰ğ˜…áƒ§Å¾")
    );

    text = u8"Ñ¦ğ™±Æ‡á—Î£â„±ÔÒ¤Ù¡ğ”Ğšğ“›ğ“œÆÈğš¸ğ‘„á¹šğ“¢á¹®á¹ºÆ²á”ê“«ğšˆğš­ğœ¶áÃ§áƒ«ğ‘’ğ–¿ğ—€á¸§ğ—‚ğ£ÒÉ­á¸¿ğ•Ÿğ¨ğ”ğ•¢á¹›ğ“¼Ñ‚Ãºğ”³áºƒâ¤¬ğ²ğ—“";
    EXPECT_EQ(
      StringConverter::WideFromUtf8(text),
      std::wstring(L"Ñ¦ğ™±Æ‡á—Î£â„±ÔÒ¤Ù¡ğ”Ğšğ“›ğ“œÆÈğš¸ğ‘„á¹šğ“¢á¹®á¹ºÆ²á”ê“«ğšˆğš­ğœ¶áÃ§áƒ«ğ‘’ğ–¿ğ—€á¸§ğ—‚ğ£ÒÉ­á¸¿ğ•Ÿğ¨ğ”ğ•¢á¹›ğ“¼Ñ‚Ãºğ”³áºƒâ¤¬ğ²ğ—“")
    );

    text = u8"ğ– Î’ğ’ğ˜‹ğ™´ğ“•Ä¢Èá»ˆğ•µê“—ÊŸğ™¼â„•à§¦ğš¸ğ—¤Õ€ê“¢á¹°Ç“â…¤ğ”šâ²¬ğ‘Œğ™•ğ˜¢ğ•¤";
    EXPECT_EQ(
      StringConverter::WideFromUtf8(text),
      std::wstring(L"ğ– Î’ğ’ğ˜‹ğ™´ğ“•Ä¢Èá»ˆğ•µê“—ÊŸğ™¼â„•à§¦ğš¸ğ—¤Õ€ê“¢á¹°Ç“â…¤ğ”šâ²¬ğ‘Œğ™•ğ˜¢ğ•¤")
    );
  }

  // ------------------------------------------------------------------------------------------- //

  TEST(StringConverterTest, CanConvertWideToUtf8) {
    std::wstring text = L"ÄƒÑ£ğ” Õ®á»Å¿Ä£ÈŸá¥ğ’‹Ç©Ä¾á¸¿ê‘È¯ğ˜±ğ‘ğ—‹ğ˜´È¶ğ„ğœˆÏˆğ’™ğ˜†ğš£";
    EXPECT_EQ(StringConverter::Utf8FromWide(text), u8"ÄƒÑ£ğ” Õ®á»Å¿Ä£ÈŸá¥ğ’‹Ç©Ä¾á¸¿ê‘È¯ğ˜±ğ‘ğ—‹ğ˜´È¶ğ„ğœˆÏˆğ’™ğ˜†ğš£");

    text = L"ğ˜ˆá¸†ğ–¢ğ•¯Ù¤á¸ÔĞÇğ™…Æ˜Ô¸â²˜ğ™‰à§¦Î¡ğ—¤ÉŒğ“¢ÈšĞ¦ğ’±Ñ ğ“§Æ³È¤Ñ§á–¯Ä‡ğ—±á»…ğ‘“ğ™œá‚¹ğ²ğ‘—ğ’ŒÄ¼á¹ƒÅ‰Ğ¾ğğ’’áµ²êœ±ğ™©á»«ğ—Åµğ’™ğ’šÅº";
    EXPECT_EQ(
      StringConverter::Utf8FromWide(text),
      std::u8string(u8"ğ˜ˆá¸†ğ–¢ğ•¯Ù¤á¸ÔĞÇğ™…Æ˜Ô¸â²˜ğ™‰à§¦Î¡ğ—¤ÉŒğ“¢ÈšĞ¦ğ’±Ñ ğ“§Æ³È¤Ñ§á–¯Ä‡ğ—±á»…ğ‘“ğ™œá‚¹ğ²ğ‘—ğ’ŒÄ¼á¹ƒÅ‰Ğ¾ğğ’’áµ²êœ±ğ™©á»«ğ—Åµğ’™ğ’šÅº")
    );

    text = L"Ğá¸‚â²¤ğ——ğ–¤ğ—™ê ê“§ÈŠğ‰ğœ¥ê“¡ğ‘€ğ‘µÇ¬ğ™¿ğ‘„Å–ğ‘†ğ’¯ğ–´ğ˜ğ˜ê“«Å¸ğœ¡áº£ğ˜¢Æ€ğ–¼á¸‹áº¿áµ®â„Šğ™á¥ğ•›ĞºÎ¹á¹ƒÕ¤â±ºğ“…ğ˜²ğ•£ğ–˜Å§ğ‘¢á¹½áº‰ğ˜…áƒ§Å¾";
    EXPECT_EQ(
      StringConverter::Utf8FromWide(text),
      std::u8string(u8"Ğá¸‚â²¤ğ——ğ–¤ğ—™ê ê“§ÈŠğ‰ğœ¥ê“¡ğ‘€ğ‘µÇ¬ğ™¿ğ‘„Å–ğ‘†ğ’¯ğ–´ğ˜ğ˜ê“«Å¸ğœ¡áº£ğ˜¢Æ€ğ–¼á¸‹áº¿áµ®â„Šğ™á¥ğ•›ĞºÎ¹á¹ƒÕ¤â±ºğ“…ğ˜²ğ•£ğ–˜Å§ğ‘¢á¹½áº‰ğ˜…áƒ§Å¾")
    );

    text = L"Ñ¦ğ™±Æ‡á—Î£â„±ÔÒ¤Ù¡ğ”Ğšğ“›ğ“œÆÈğš¸ğ‘„á¹šğ“¢á¹®á¹ºÆ²á”ê“«ğšˆğš­ğœ¶áÃ§áƒ«ğ‘’ğ–¿ğ—€á¸§ğ—‚ğ£ÒÉ­á¸¿ğ•Ÿğ¨ğ”ğ•¢á¹›ğ“¼Ñ‚Ãºğ”³áºƒâ¤¬ğ²ğ—“";
    EXPECT_EQ(
      StringConverter::Utf8FromWide(text),
      std::u8string(u8"Ñ¦ğ™±Æ‡á—Î£â„±ÔÒ¤Ù¡ğ”Ğšğ“›ğ“œÆÈğš¸ğ‘„á¹šğ“¢á¹®á¹ºÆ²á”ê“«ğšˆğš­ğœ¶áÃ§áƒ«ğ‘’ğ–¿ğ—€á¸§ğ—‚ğ£ÒÉ­á¸¿ğ•Ÿğ¨ğ”ğ•¢á¹›ğ“¼Ñ‚Ãºğ”³áºƒâ¤¬ğ²ğ—“")
    );

    text = L"ğ– Î’ğ’ğ˜‹ğ™´ğ“•Ä¢Èá»ˆğ•µê“—ÊŸğ™¼â„•à§¦ğš¸ğ—¤Õ€ê“¢á¹°Ç“â…¤ğ”šâ²¬ğ‘Œğ™•ğ˜¢ğ•¤";
    EXPECT_EQ(
      StringConverter::Utf8FromWide(text),
      std::u8string(u8"ğ– Î’ğ’ğ˜‹ğ™´ğ“•Ä¢Èá»ˆğ•µê“—ÊŸğ™¼â„•à§¦ğš¸ğ—¤Õ€ê“¢á¹°Ç“â…¤ğ”šâ²¬ğ‘Œğ™•ğ˜¢ğ•¤")
    );
  }

  // ------------------------------------------------------------------------------------------- //

  TEST(StringConverterTest, Utf8StringsCanBeCaseFolded) {
    std::u8string variant1 = u8"HeLlO wOrLd Ã„ Ã¶ Ãœ Î» Î¦ Î´ áº";
    std::u8string variant2 = u8"hElLo WoRlD Ã¤ Ã– Ã¼ Î› Ï† Î” ÃŸ";
    std::u8string wrong1 = u8"hElLo WoRlD A o U Î» Î¦ Î” B";
    std::u8string wrong2 = u8"hElLo WoRlD Ã¤ Ã¶ Ã¼ ^ & âˆ© b";

    EXPECT_EQ(
      StringConverter::FoldedLowercaseFromUtf8(variant1),
      StringConverter::FoldedLowercaseFromUtf8(variant2)
    );
    EXPECT_NE(
      StringConverter::FoldedLowercaseFromUtf8(variant1),
      StringConverter::FoldedLowercaseFromUtf8(wrong1)
    );
    EXPECT_NE(
      StringConverter::FoldedLowercaseFromUtf8(variant2),
      StringConverter::FoldedLowercaseFromUtf8(wrong2)
    );
  }

  // ------------------------------------------------------------------------------------------- //

  TEST(StringConverterTest, Utf8CharactersCanBeCounted) {

    // Symbols that require 4 bytes to represent in UTF-8. If your IDE doesn't display this,
    // that's fine. Just, maybe, don't save this file!
    // (it's a fly, a snake, an alligator and a fish symbol from egyptian hieroglyphs)
    std::u8string fourByteSymbols = u8"ğ“†¦ğ“†“ğ“†Œğ“†Ÿ";
    EXPECT_EQ(StringConverter::CountUtf8CodePoints(fourByteSymbols), 4U);

    // Also try with some less exotic UTF-8 characters using 2 or 3 bytes.
    std::u8string otherSymbols = u8"ğ– Î’ğ’ğ˜‹ğ™´ğ“•Ä¢Èá»ˆğ•µê“—ÊŸğ™¼â„•à§¦ğš¸ğ—¤Õ€ê“¢á¹°Ç“â…¤ğ”šâ²¬ğ‘Œğ™•ğ˜¢ğ•¤";
    EXPECT_EQ(StringConverter::CountUtf8CodePoints(otherSymbols), 28U);

  }

  // ------------------------------------------------------------------------------------------- //

}}} // namespace Nuclex::Support::Text
